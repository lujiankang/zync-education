<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>班级管理</title>
	<meta charset="utf-8" />
	<link rel='icon' href="__PUBLIC__/images/index.ico" />
	<!-- 移动端适应 -->
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- jQuery -->
	<script src="__PUBLIC__/js/jQuery/jquery-2.1.4.min.js"></script>
	<!-- Bootstrap -->
	<link href="__PUBLIC__/css/bootstrap/bootstrap.min.css" rel="stylesheet" />
	<script src="__PUBLIC__/js/bootstrap/bootstrap.min.js"></script>
	<!-- 字体图标 -->
	<link href="__PUBLIC__/css/awesome/font-awesome.css" rel="stylesheet" />
	<!-- k360 -->
	<script src="__PUBLIC__/js/k360/k360-scroll-bar.js"></script>
	<script src="__PUBLIC__/js/k360/k360-http.js"></script>
	<script src="__PUBLIC__/js/k360/k360-popover.js"></script>

	<!-- 当前页面css -->
	<link href="__PUBLIC__/css/base/page.css" rel="stylesheet" />
	<!-- 当前页面js -->
	<script src="__PUBLIC__/js/base/k360-bt-page.js"></script>
	<script src="__PUBLIC__/js/base/func.js"></script>
	<script src="__PUBLIC__/js/base/resp-head.js"></script>
	<script src="__PUBLIC__/js/base/top-nav.js"></script>
	<script src="__PUBLIC__/js/k360/k360-tag.js"></script>
	<link href="__PUBLIC__/css/base/animate.css" rel="stylesheet" />
</head>
<body>
	<!-- 头部 -->
	<div class="row header">
		<div class="col-md-12">
			<div class="header-close" onclick="top.respShower.style.display = 'none'"><i class="fa fa-close"></i></div>
			<div class="fa fa-paw icon"></div>
			<span class="title">班级管理</span>
			<div class="header-menu"><i class="fa fa-reorder"></i></div>
		</div>
	</div>

	<div class="data-detail" style="overflow:hidden">
		<iframe width="100%" height="100%" frameborder="0" src="__MODULE__/User/pUserCtrl"></iframe>
	</div>

	<div class="data-core">
		<!-- 顶部操作 -->
		<div class="row handles">
			<div class="col-sm-6 top-btns">
				<button class="handle-item btn btn-danger" id="classCreateBtn"><i class="fa fa-plus"></i>添加班级</button>
			</div>
			<div class="col-sm-6 top-search">
				<div class="handle-item">
					<form class="item-group" id="classSearchForm" style="float:right">
						<input type="text" name="key" class="form-control" placeholder="关键字检索：班级名、年级、教师" style="width:200px">
						<button type="submit" class="btn btn-primary btn-group"><i class="fa fa-search">&nbsp;</i><span>检索</span></button>
						<div class="float-clear"></div>
					</form>
				</div>
				<div class="float-clear"></div>
			</div>
		</div>

		<!-- 主体 -->
		<div class="row main margin-top-20" k360-scroll-y="4" k360-scroll-keep>
			<div class="col-md-12 table-responsive">
				<table class="table table-hover">
					<thead>
						<tr>
							<th>班级名称</th>
							<th>班主任</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody id="dataShower">
						<tr>
							<td>xxxx</td>
							<td>xxx</td>
							<td width="100">
								<button class="btn btn-sm btn-danger fa fa-trash to-remove" title="删除班级"></button>
								<button class="btn btn-sm btn-warning fa fa-pencil to-change" title="修改班级信息"></button>
							</td>
						</tr>
					</tbody>
				</table>
				<div class="dataLoading"><i class="fa fa-spinner fa-spin"></i>正在加载..</div>
			</div>
		</div>

		<!-- 分页控件 -->
		<div class="row page margin-top-20">
			<div class="col-md-12" style="text-align:center">
				<div style="display:inline-block">
					<button class="btn btn-success goto-last">上一页</button>
					<button class="btn btn-success goto-next">下一页</button>
					<div class="item-group">
						<input type="text" class="form-control goto-input" value="1" style="width:50px; display:inline-block" />
						<button class="btn btn-primary goto-button">&nbsp;跳转&nbsp;</button>
					</div>
				</div>
				<div style="display:inline-block; margin-left:30px" class="k-page-info">
					共<span class="data-num"> - </span>条数据，共<span class="page-num"> - </span>页，第<span class="page-now"> - </span>页
				</div>
			</div>
		</div>
	</div>
	<!-- 创建班级 -->
	<div class="inputer" id="classCreator">
		<div class="animated zoomInUp">
			<div class="container-400">
				<form id="classCreateForm" action="__CONTROLLER__/aCreate">
					<div class="form-group">
						<label>班级名称</label>
						<input type="text" class="form-control" name="name" placeholder="如：计科系（2）班" required>
					</div>
					<div class="form-group">
						<label>年级</label>
						<input type="text" class="form-control" name="grade" placeholder="如：2016" required>
					</div>
					<div class="form-group">
						<label>班主任</label>
						<select class="form-control" name="teacher" required>
						</select>
					</div>
					<button type="submit" class="btn btn-success btn-loading">
						&nbsp;&nbsp;<i class="fa fa-spin fa-spinner"></i>&nbsp;&nbsp;添&nbsp;加&nbsp;&nbsp;
					</button>
					<button type="button" class="btn btn-warning" onclick="classCreator.style.display = 'none'">&nbsp;&nbsp;取&nbsp;消&nbsp;&nbsp;</button>
				</form>
			</div>
		</div>
	</div>
	
	<!-- 修改班级信息 -->
	<div class="inputer" id="classUpdater">
		<div class="animated zoomInUp">
			<div class="container-400">
				<form id="classUpdateForm" action="__CONTROLLER__/aUpdate">
					<input type="text" name="cid" style="display:none" />
					<div class="form-group">
						<label>班级名称</label>
						<input type="text" class="form-control" name="name" placeholder="如：计科系（2）班" required />
					</div>
					<div class="form-group">
						<label>年级</label>
						<input type="text" class="form-control" name="grade" placeholder="如：2016" required />
					</div>
					<div class="form-group">
						<label>班主任</label>
						<select class="form-control" name="teacher" required></select>
					</div>
					<button type="submit" class="btn btn-success btn-loading">
						&nbsp;&nbsp;<i class="fa fa-spin fa-spinner"></i>&nbsp;&nbsp;保&nbsp;存&nbsp;&nbsp;
					</button>
					<button type="button" class="btn btn-warning" onclick="classUpdater.style.display = 'none'">&nbsp;&nbsp;取&nbsp;消&nbsp;&nbsp;</button>
				</form>
			</div>
		</div>
	</div>
</body>
</html>


<script>

	window._GETTEACHER = "__MODULE__/User/gTeachersAll";
	window._GETCLASSES = "__CONTROLLER__/gClasses";
	window._DELETECLASS = "__CONTROLLER__/aRemove";

	window.class_main_controller = {
		create: function () {

			var obj = {};
			var page = k360_bt_page.create(".page");

			//克隆一个tr
			var clonedTR = dataShower.children[0].cloneNode(true);

			var teachers = null;			//添加/修改班级是教师列表
			var key = "";

			obj.init = function () {
				//分页页面跳转
				page.onpage(function (to) {
					loadClasses(to);
				});
				//分页操作错误提示
				page.onerror(function (err) {
					k360_popover.create().setTopPop(true).toast(err);
				});
				//点击创建班级按钮
				classCreateBtn.onclick = function () {
					classCreator.style.display = "inline-block";
					inputerCenter(classCreator);
					teacherShowAtSelect(classCreateForm.teacher);	//显示教师
				}
				//创建班级表单提交事件
				classCreateForm.onsubmit = function () {
					var btn = this.querySelector("button[type='submit']");
					btn.disabled = true;
					k360_http.create().addForm(this)
					.onsuccess(function (data, xhr) {
						btn.disabled = false;
						if (data.reson) {
							k360_popover.create().setTopPop(true).toast(data.reson);
							return;
						}
						//刷新
						loadClasses(page.getCurPage());
						//提示
						k360_popover.create().setTopPop(true).confirm("完成", "班级已经创建成功了，是否继续添加？")
						.setOnCancel(function () {
							classCreator.style.display = "none";
						});
					})
					.onerror(function (xhr, status, statusText) {
						btn.disabled = false;
						k360_popover.create().setTopPop(true).toast("创建班级错误，可能是网络原因，状态码：" + status);
					})
					.send();
					return false;
				}
				//修改班级表单提交时间
				classUpdateForm.onsubmit = function () {
					var btn = this.querySelector("button[type='submit']");
					btn.disabled = true;
					k360_http.create().addForm(this)
					.onsuccess(function (data, xhr) {
						btn.disabled = false;
						if (data.reson) {
							k360_popover.create().setTopPop(true).toast(data.reson);
							return;
						}
						//刷新
						loadClasses(page.getCurPage());
						classUpdater.style.display = "none";
					})
					.onerror(function (xhr, status, statusText) {
						btn.disabled = false;
						k360_popover.create().setTopPop(true).toast("修改班级信息错误，可能是网络问题，状态码：" + status);
					})
					.send();
					return false;
				}
				//检索提交
				classSearchForm.onsubmit = function () {
					key = this.key.value ? this.key.value : "";
					loadClasses(0);
					this.key.focus();
					return false;
				}
				loadClasses(0);
			}

			//加载班级
			function loadClasses(toPage) {
				//删除旧数据
				while (dataShower.children.length > 0) {
					dataShower.removeChild(dataShower.children[0]);
				}
				//锁
				var loading = document.querySelector(".dataLoading");
				loading.style.display = "inline-block";
				page.lock();
				//加载
				k360_http.create().setUrl(_GETCLASSES).addData({ page: toPage, key: key })
				.onsuccess(function (data, xhr) {
					loading.style.display = "none";
					page.unlock();
					if (data.reson) {
						k360_popover.create().setTopPop(true).toast(data.reson);
						return;
					}
					//分页
					page.setInfo(data.data.pages, data.data.count, toPage);
					//显示列表
					var classes = data.data.datas;
					for (var i in classes) {
						var aClass = classes[i];
						var tr = clonedTR.cloneNode(true);
						tr.children[0].innerHTML = aClass.grade + "级 " + aClass.name;
						tr.children[1].innerHTML = aClass.teachername;
						setDataTREvent(tr.children[2], aClass);
						dataShower.appendChild(tr);
					}
				})
				.onerror(function (xhr, status, statusText) {
					loading.style.display = "none";
					page.unlock();
					k360_popover.create().setTopPop(true).toast("获取班级列表错误，可能是网络问题，状态码：" + status);
				})
				.send();
			}

			//设置一行数据的操作事件
			function setDataTREvent(td, aClass) {
				td.querySelector(".to-remove").onclick = function () {
					deleteClass(aClass);
				}
				td.querySelector(".to-change").onclick = function () {
					classUpdater.style.display = "inline-block";
					inputerCenter(classUpdater);
					//填充数据
					teacherShowAtSelect(classUpdateForm.teacher, aClass.teacher);
					classUpdateForm.cid.value = aClass.id;
					classUpdateForm.name.value = aClass.name;
					classUpdateForm.grade.value = aClass.grade;
				}
			}

			//删除班级
			function deleteClass(aClass) {
				k360_popover.create().setTopPop(true).confirm("警告", "是否要删除“" + aClass.grade + "级 " + aClass.name + "”，删除后可能会导致教学中的不可知的错误，请慎重", "删除", "取消")
				.setOnOk(function () {
					var loading = k360_popover.create().setTopPop(true).loading()
					k360_http.create().setUrl(_DELETECLASS).addOne("id", aClass.id)
					.onsuccess(function (data, xhr) {
						loading.distroy();
						if (data.reson) {
							k360_popover.create().setTopPop(true).toast(data.reson);
							return;
						}
						//刷新
						loadClasses(page.getCurPage());
					})
					.onerror(function (xhr, status, statusText) {
						loading.distroy();
						k360_popover.create().setTopPop(true).toast("删除班级错误，可能是网络问题，状态码：" + status);
					})
					.send();
				});
			}

			//将教师列表显示到某个select中
			function teacherShowAtSelect(select, selected) {
				//显示
				function show() {
					select.innerHTML = "";
					for (var i in teachers) {
						var teacher = teachers[i];
						select.innerHTML += "<option value='" + teacher.id + "'>" + teacher.name + "</option>";
					}
					select.value = selected ? selected : teachers[0].id;
				}
				function load() {
					select.innerHTML = "<option disabled>数据正在加载中。。。</option>";
					k360_http.create().setUrl(_GETTEACHER)
					.onsuccess(function (data, xhr) {
						if (data.reson) {
							select.innerHTML = "<option disabled>" + data.reson + "</option>";
							return;
						}
						teachers = data.data;
						show();
					})
					.onerror(function (xhr, status, statusText) {
						select.innerHTML = "<option disabled>加载教师错误，可能是网络问题，" + status + "</option>";
					})
					.send();
				}
				//判断有没有加载教师
				teachers ? show() : load();
			}

			return obj;
		}
	};

	window.addEventListener("load", function () {
		class_main_controller.create().init();
	});


</script>